# See https://desc-continuous-integration.readthedocs.io/en/latest/index.html for more info.
# Author - Stuart McAlpine - August 2022

name: DESC Example 3

# How does the workflow get triggered?
on:
  # Automatically run every Friday at midnight.
  schedule:
    - cron: '0 0 * * 4'
  # Have option to manually trigger workflow.
  workflow_dispatch: null

# List of jobs for this workflow.
jobs:
  ci-with-pytest:
    
    # Our strategy lists the OS and Python versions containers to run within.
    strategy:

      # Don't quit all jobs if only one job fails.
      fail-fast: false
      
      matrix:
        python-version: [py37, py38, py39]
        os: [ubuntu-18.04, ubuntu-20.04]

    # What operating system is this job running on?
    runs-on: ubuntu-latest

    # Specify the lsstdesc container to pull from DockerHub and operate within.
    container: lsstdesc/desc-python-${{ matrix.os}}-${{ matrix.python-version}}:ci-dev

    # Our CI steps for this job.
    steps:
     
      # Check out this repository code.
      - name: Check out repository code
        uses: actions/checkout@v3

      # Do some basic code linting using flake8. Check for syntax and indentation errors.
      - name: flake8 linting.
        run: flake8 --count --select=E1,E9 --show-source --statistics ./python/my_arithmetic.py

      # Perform the unit tests and output a report.
      - name: Test with pytest
        run: |
          mamba install -y pytest-cov
          pytest --cov --cov-report xml ./python
                
      # Upload the code coverage results to codecov.io.
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v2
